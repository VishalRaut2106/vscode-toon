name: Publish Stable Release

on:
  workflow_dispatch:
    inputs:
      confirm:
        description: 'Publish current version as STABLE release (not pre-release)'
        required: true
        default: 'yes'
        type: choice
        options:
        - 'yes'
        - 'no'

jobs:
  publish-stable:
    runs-on: ubuntu-latest
    if: github.event.inputs.confirm == 'yes'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Get current version
      id: version
      run: |
        VERSION=$(node -p "require('./package.json').version")
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "ğŸ“¦ Publishing STABLE version: $VERSION"
    
    - name: Compile and package
      run: |
        npm run compile
        npm run package
    
    - name: Verify VSIX created
      run: |
        if ls *.vsix 1> /dev/null 2>&1; then
          echo "âœ… VSIX file created successfully"
          ls -la *.vsix
        else
          echo "âŒ No VSIX file found"
          exit 1
        fi
    
    - name: Install VSCE
      run: npm install -g @vscode/vsce
    
    - name: Publish STABLE release to VS Code Marketplace
      env:
        VSCE_PAT: ${{ secrets.VSCE_PAT }}
      run: |
        echo "ğŸš€ Publishing STABLE release to VS Code Marketplace..."
        echo "âš ï¸  This will OVERWRITE any pre-release version with the same number"
        vsce publish --packagePath *.vsix
        echo "âœ… Successfully published STABLE version ${{ steps.version.outputs.version }}!"
    
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: vscode-toon-stable-v${{ steps.version.outputs.version }}
        path: "*.vsix"
        retention-days: 30
    
    - name: Success summary
      run: |
        echo "ğŸ‰ STABLE Release Published!"
        echo "ğŸ“¦ Version: ${{ steps.version.outputs.version }}"
        echo "ğŸ”— Marketplace: https://marketplace.visualstudio.com/items?itemName=vishalraut.vscode-toon"
        echo "ğŸ“¥ Install: code --install-extension vishalraut.vscode-toon"
        echo ""
        echo "âœ… This version is now marked as STABLE (not pre-release)"
        echo "â° It may take a few minutes to appear on the marketplace."