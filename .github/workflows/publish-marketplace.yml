name: Publish to Marketplace

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to publish (leave empty for current package.json version)'
        required: false
        default: ''

jobs:
  publish:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Get current version
      id: version
      run: |
        CURRENT_VERSION=$(node -p "require('./package.json').version")
        INPUT_VERSION="${{ github.event.inputs.version }}"
        PUBLISH_VERSION=${INPUT_VERSION:-$CURRENT_VERSION}
        echo "version=$PUBLISH_VERSION" >> $GITHUB_OUTPUT
        echo "Publishing version: $PUBLISH_VERSION"
    
    - name: Compile TypeScript
      run: npm run compile
    
    - name: Run linting
      run: npm run lint
    
    - name: Package extension
      run: npm run package
    
    - name: Verify VSIX created
      run: |
        if ls *.vsix 1> /dev/null 2>&1; then
          echo "‚úÖ VSIX file created successfully"
          ls -la *.vsix
        else
          echo "‚ùå No VSIX file found"
          exit 1
        fi
    
    - name: Install VSCE
      run: npm install -g @vscode/vsce
    
    - name: Verify VSCE login
      env:
        VSCE_PAT: ${{ secrets.VSCE_PAT }}
      run: |
        echo "Testing VSCE authentication..."
        echo "$VSCE_PAT" | vsce login vishalraut
        vsce ls-publishers
    
    - name: Publish to VS Code Marketplace
      env:
        VSCE_PAT: ${{ secrets.VSCE_PAT }}
      run: |
        echo "Publishing to VS Code Marketplace..."
        vsce publish --packagePath *.vsix
        echo "‚úÖ Successfully published to VS Code Marketplace!"
    
    - name: Publish to Open VSX Registry
      env:
        OVSX_PAT: ${{ secrets.OVSX_PAT }}
      run: |
        if [ -n "$OVSX_PAT" ]; then
          echo "Publishing to Open VSX Registry..."
          npm install -g ovsx
          ovsx publish *.vsix -p $OVSX_PAT
          echo "‚úÖ Successfully published to Open VSX Registry!"
        else
          echo "‚ö†Ô∏è OVSX_PAT not found, skipping Open VSX Registry"
        fi
      continue-on-error: true
    
    - name: Upload VSIX artifact
      uses: actions/upload-artifact@v4
      with:
        name: vscode-toon-${{ steps.version.outputs.version }}
        path: "*.vsix"
        retention-days: 30
    
    - name: Success notification
      run: |
        echo "üéâ Extension published successfully!"
        echo "üì¶ Version: ${{ steps.version.outputs.version }}"
        echo "üîó Marketplace: https://marketplace.visualstudio.com/items?itemName=vishalraut.vscode-toon"
        echo "üì• Install: code --install-extension vishalraut.vscode-toon"