name: Simple Marketplace Publish

on:
  workflow_dispatch:
    inputs:
      force_publish:
        description: 'Force publish current version'
        required: false
        default: 'true'
        type: boolean

jobs:
  publish:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Get current version
      id: version
      run: |
        VERSION=$(node -p "require('./package.json').version")
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "ğŸ“¦ Current version: $VERSION"
    
    - name: Compile and package
      run: |
        npm run compile
        npm run package
    
    - name: Verify VSIX created
      run: |
        if ls *.vsix 1> /dev/null 2>&1; then
          echo "âœ… VSIX file created successfully"
          ls -la *.vsix
        else
          echo "âŒ No VSIX file found"
          exit 1
        fi
    
    - name: Install VSCE
      run: npm install -g @vscode/vsce
    
    - name: Test VSCE authentication
      env:
        VSCE_PAT: ${{ secrets.VSCE_PAT }}
      run: |
        echo "ğŸ” Testing VSCE authentication..."
        if [ -z "$VSCE_PAT" ]; then
          echo "âŒ VSCE_PAT secret is not set!"
          echo "Please add your Azure DevOps PAT token to GitHub secrets"
          exit 1
        fi
        
        echo "$VSCE_PAT" | vsce login vishalraut
        echo "âœ… Authentication successful"
    
    - name: Publish to VS Code Marketplace
      env:
        VSCE_PAT: ${{ secrets.VSCE_PAT }}
      run: |
        echo "ğŸš€ Publishing to VS Code Marketplace..."
        vsce publish --packagePath *.vsix
        echo "âœ… Successfully published version ${{ steps.version.outputs.version }}!"
    
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: vscode-toon-v${{ steps.version.outputs.version }}
        path: "*.vsix"
        retention-days: 30
    
    - name: Success summary
      run: |
        echo "ğŸ‰ Publication Complete!"
        echo "ğŸ“¦ Version: ${{ steps.version.outputs.version }}"
        echo "ğŸ”— Marketplace: https://marketplace.visualstudio.com/items?itemName=vishalraut.vscode-toon"
        echo "ğŸ“¥ Install: code --install-extension vishalraut.vscode-toon"
        echo ""
        echo "â° It may take a few minutes for the new version to appear on the marketplace."