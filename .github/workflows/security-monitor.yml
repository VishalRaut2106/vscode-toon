name: Security Monitoring

on:
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:

jobs:
  security-audit:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Run security audit
      id: audit
      run: |
        npm audit --audit-level=moderate --json > audit-results.json || true
        VULNERABILITIES=$(cat audit-results.json | jq '.metadata.vulnerabilities.total // 0')
        echo "vulnerabilities=$VULNERABILITIES" >> $GITHUB_OUTPUT
        
        if [ "$VULNERABILITIES" -gt 0 ]; then
          echo "ðŸš¨ Found $VULNERABILITIES vulnerabilities!"
          npm audit --audit-level=moderate
        else
          echo "âœ… No vulnerabilities found!"
        fi
    
    - name: Check for outdated packages
      run: |
        echo "ðŸ“¦ Checking for outdated packages..."
        npm outdated || true
    
    - name: Verify extension authenticity
      run: |
        echo "ðŸ” Verifying extension authenticity..."
        node verify-official.js
    
    - name: Monitor marketplace for fake extensions
      run: |
        echo "ðŸ” Monitoring marketplace for fake TOON extensions..."
        echo "Manual check required: https://marketplace.visualstudio.com/search?term=toon&target=VSCode"
    
    - name: Create security issue if vulnerabilities found
      if: steps.audit.outputs.vulnerabilities > 0
      uses: actions/github-script@v7
      with:
        script: |
          const vulnerabilities = ${{ steps.audit.outputs.vulnerabilities }};
          
          const issueBody = `
          ## ðŸš¨ Security Alert: Vulnerabilities Detected
          
          **Vulnerabilities Found**: ${vulnerabilities}
          **Detection Date**: ${new Date().toISOString().split('T')[0]}
          **Workflow**: Security Monitoring
          
          ### ðŸ“‹ Action Required
          1. Review the security audit results
          2. Update vulnerable dependencies
          3. Test the extension after updates
          4. Create a security patch release if needed
          
          ### ðŸ”§ Commands to Fix
          \`\`\`bash
          npm audit fix
          npm run compile
          npm run package
          \`\`\`
          
          ### ðŸ“Š Audit Results
          Run \`npm audit\` for detailed vulnerability information.
          
          ---
          
          *This issue was automatically created by the Security Monitoring workflow.*
          `;
          
          await github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: `ðŸš¨ Security Alert: ${vulnerabilities} vulnerabilities detected`,
            body: issueBody,
            labels: ['security', 'vulnerability', 'automated']
          });

  dependency-review:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Dependency Review
      uses: actions/dependency-review-action@v4
      with:
        fail-on-severity: moderate
        allow-licenses: MIT, Apache-2.0, BSD-2-Clause, BSD-3-Clause, ISC